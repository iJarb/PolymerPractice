<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/scheduler-component/scheduler-component.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">


<dom-module id="p2-calender-app">
  <template>
    <style>
      :host {
        display: block;
        --paper-toast-background-color: #EEE;
      }
      .booking-toast {
        color: #333;
        font-size: 1.2em;
        line-height: 150%;
      }
      #cancelCreateEventBtn, #cancelUpdateEventBtn {
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 10px;
      }
      #eventNameInput, #eventNameUpdateInput{
        width: 300px;
        margin: 15px 0;
      }
    </style>
    <h2>Hello [[prop1]]!</h2>
    <scheduler-component id="calender"
        default-view="agendaWeek"
        editable week-numbers
        max-time="18:00:00" min-time="07:00:00"
        categories='[{ "label": "Approved", "color": "#1abc9c","hidden":false },
        { "label": "Pending", "color": "#B4BBFE","hidden":false }]'
        event-color="#8e44ad"
        text-color="#ecf0f1"
        events='{{data}}'
        header='{"center":"title","left":"prev,next,today","right":"month,agendaWeek,agendaDay"}'>
    </scheduler-component>
    <button on-click="_goNext">Next</button>
    <button on-click="_addEvent">Add Event</button>
    <paper-toast id="dayClickToastStart" class="booking-toast" duration="0" text="">
        You selected [[fromTimeClick.date]] at [[fromTimeClick.time]].<br/>
        Please click on the same day for the end time of your booking.
    </paper-toast>
    <paper-toast id="dayClickToastEnd" class="booking-toast" duration="0" text="" no-cancel-on-esc-key="true">
          Date: [[fromTimeClick.date]]<br/>
          From: [[fromTimeClick.time]]<br/>
          To: [[toTimeClick.time]]<br/>

          <paper-input label="Enter an event name..." id="eventNameInput" autofocus="true"></paper-input>
          <paper-button raised id="createEventBtn" on-tap="_createEvent">Create</paper-button>
          <iron-icon id="cancelCreateEventBtn" icon="icons:remove-circle" on-click="_toggleEndToast"></iron-icon>
      </paper-toast>
    <paper-toast id="eventClickToast" class="booking-toast" duration="0" text="">
      Date: [[_getDateFromEventTime(booking.start)]]<br/>
      From: [[_getTimeFromEventTime(booking.start)]]<br/>
      To: [[_getTimeFromEventTime(booking.end)]]<br/>

      <paper-input label="Enter an event name..." id="eventNameUpdateInput" autofocus="true" value="[[booking.title]]"></paper-input>
      <paper-button raised id="updateEventBtn" on-tap="_updateEvent">Update</paper-button>
      <paper-button raised id="deleteEventBtn" on-tap="_deleteEvent">Delete</paper-button>
      <iron-icon id="cancelUpdateEventBtn" icon="icons:remove-circle" on-click="_toggleEventToast"></iron-icon>
    </paper-toast>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class P2CalenderApp extends Polymer.Element {
      static get is() { return 'p2-calender-app'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'p2-calender-app'
          },
          data: {
            type: Array,
            value: [],
            notify: true
          },
          fromTimeClick: {
            type: Object,
            value: () => {}
          },
          toTimeClick: {
            type: Object,
            value: () => {}
          },
          booking: {
            type: Object,
            value: () => {},
            notify: true
          }
        };
      }

      ready() {
        super.ready();
        var cal = this.$.calender;
        cal.addEventListener('event-resize', (e)=>this._onEventResize(e));
        cal.addEventListener('event-drop', (e)=>this._onEventDrop(e));
        cal.addEventListener('event-click', (e)=>this._onEventClick(e));
        cal.addEventListener('day-click', (e)=>this._onDayClick(e));
        /*cal.addEventListener('event-drag-start', (e)=>this._onDragStart(e));
        cal.addEventListener('event-drag-end', (e)=>this._onDragEnd(e));
        cal.addEventListener('event-mouse-over', (e)=>this._onMouseOver(e));*/
      }

      connectedCallback() {
        super.connectedCallback();
        Polymer.RenderStatus.afterNextRender(this, function() {
          this.data = [
            {"id": "1", "title" : "event1","start" : "2018-08-06","allDay" :false},
            {"id": "2", "title" : "event2","start" : "2018-08-08T08:30:00","end" : "2018-08-08T10:30:00", "category":"Approved"},
            {"id": "3", "title" : "event3","start" : "2018-08-10T12:30:00","end" : "2018-08-10T16:30:00", "category":"Pending"},
            {"id": "5", "title" : "event4","start" : "2018-08-11T12:30:00","allDay" :false},
            {"id": "6", "title" : "event5","start" : "2018-08-16T12:30:00","end" : "2018-08-16T16:30:00","category":"Approved"},
            {"id": "8", "title" : "event6","start" : "2018-08-15T12:30:00","allDay" :false, "category":"Pending"}];
          this._refresh();
        });
      }

      _goNext() {
        var cal = this.$.calender;
        cal.next();
      }

      _refresh() {
        var cal = this.$.calender;
        cal.next();
        cal.prev();
      }
      _onEventResize(e) {
        console.log(e.detail.event.start, " - ", e.detail.event.end); //month counts from 0
      }
      _onEventDrop(e) {
        console.log(e, this.data);
      }
      _addEvent() {
        let newEvent = {"id": "345", "title" : "eventNew","start" : "2018-08-09T11:30:00","end" : "2018-08-09T15:30:00"};
        this.data = this._immutablePush(this.data, newEvent);
      }
      _onEventClick(e) {
        this.booking = this.data.find(b => {return b.id === e.detail.calEvent.id});
        this.$.eventClickToast.open();
      }
      _getDateFromEventTime(t){
        if (t === undefined) return '';
        return t.split("T")[0];
      }
      _getTimeFromEventTime(t){
        if (t === undefined) return '';
        return t.split("T")[1];
      }

      _immutablePush(arr, newEntry){
        let v = {};
        newEntry = Object.assign(v, newEntry);
        return [ ...arr, newEntry ]
      }
      _onDayClick(e){
        let arrData = e.detail.date._i;
        if (this.fromTimeClick === undefined || this.fromTimeClick === null) {
          this.fromTimeClick = this._convertDayClickData(arrData);
          this.$.dayClickToastStart.open();
        } else {
          this.toTimeClick = this._convertDayClickData(arrData);
          if (this.toTimeClick.date !== this.fromTimeClick.date) {
            this._toggleAndClearStartToast();
          } else {
            if (this._compareTimeInArray(this.fromTimeClick.data, this.toTimeClick.data)) {
              this.$.dayClickToastEnd.open();
              this.$.eventNameInput.focus();
            } else {
              this._toggleAndClearStartToast();
            }
          }
        }
      }

      _convertDayClickData(arr) {
        arr[1]++;
        let copyArr = arr.slice(0);
        for(let i = 0; i<arr.length; i++) {
          arr[i] = this._addZeroBefore(arr[i]);;
        }
        let date = arr[0] + "-" + arr[1] + "-" + arr[2];
        let time = arr[3] + ":" + arr[4] + ":" + arr[5];
        return {
          "date": date,
          "time": time,
          "data": copyArr
        };
      }

      _addZeroBefore(n) {
        return (n < 10) ? "0" + n : n;
      }

    /**
      return TRUE if time of arr1 is earlier than arr2
    */
      _compareTimeInArray(arr1, arr2) {
          let h1 = arr1[3];
          let m1 = arr1[4];
          let h2 = arr2[3];
          let m2 = arr2[4];
          if (h1 < h2) {
            return true;
          } else if(h1 === h2 && m1 < m2) {
            return true;
          }
          return false;
      }

      _toggleEndToast() {
        this.$.dayClickToastEnd.toggle();
        this._clearBookingCache();
      }
      _toggleAndClearStartToast() {
        this.$.dayClickToastStart.toggle();
        this._clearBookingCache();
      }
      _toggleEventToast() {
        this.$.eventClickToast.toggle();
        this.booking = null;
      }

      _createEvent() {
        let newEvent = {
          "id": "",
          "title" : this.$.eventNameInput.value,
          "start" : this.fromTimeClick.date + "T" + this.fromTimeClick.time,
          "end" : this.toTimeClick.date + "T" + this.toTimeClick.time,
          "category": "Pending"
          };
        this.data = this._immutablePush(this.data, newEvent);
        this._toggleEndToast();
      }
      _updateEvent() {
        let selectingEvent = this.data.find(b => {return b.id === this.booking.id});
        var index = this.data.indexOf(selectingEvent);
        selectingEvent.title = this.$.eventNameUpdateInput.value;
        this.data.splice(index, 1);
        this.data = this._immutablePush(this.data, selectingEvent);

        this._toggleEventToast();
      }
      _deleteEvent() {
        let selectingEvent = this.data.find(b => {return b.id === this.booking.id});
        var index = this.data.indexOf(selectingEvent);
        this.data.splice(index, 1);

        let newData = [].concat(this.data);
        this.data = newData;
        this._toggleEventToast();
      }

      _clearBookingCache(){
        this.toTimeClick = null;
        this.fromTimeClick = null;
        this.$.eventNameInput.value = "";
      }

      _onDragStart(e){
        console.log("Drag start:", e);
      }
      _onDragEnd(e){
        console.log("Drag end:", e);
      }
      _onMouseOver(e){
        console.log("Mouse over:", e);
      }
    }

    window.customElements.define(P2CalenderApp.is, P2CalenderApp);
  </script>
</dom-module>
